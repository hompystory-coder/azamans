<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDoS Flow Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .label {
            font-weight: 600;
            color: #666;
        }
        .value {
            color: #333;
            font-family: 'Courier New', monospace;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .log {
            background: #1a1a2e;
            color: #0ff;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è DDoS Protection Flow Test</h1>
        
        <div class="section">
            <h2>üìä Current Status</h2>
            <div class="info-row">
                <span class="label">localStorage Token:</span>
                <span class="value" id="localStorage-token">-</span>
            </div>
            <div class="info-row">
                <span class="label">sessionStorage Token:</span>
                <span class="value" id="sessionStorage-token">-</span>
            </div>
            <div class="info-row">
                <span class="label">Cookie Token:</span>
                <span class="value" id="cookie-token">-</span>
            </div>
            <div class="info-row">
                <span class="label">getAuthToken() Result:</span>
                <span class="value" id="auth-token-result">-</span>
            </div>
        </div>

        <div class="section">
            <h2>üß™ Actions</h2>
            <div class="actions">
                <button class="btn" onclick="checkStatus()">üîç Refresh Status</button>
                <button class="btn" onclick="testLogin()">üîë Test Login</button>
                <button class="btn" onclick="testRegister()">üìù Test DDoS Register</button>
                <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear All Storage</button>
            </div>
        </div>

        <div class="section">
            <h2>üìã Execution Log</h2>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        // Utility Functions
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function getAuthToken() {
            const sources = [
                () => localStorage.getItem('neuralgrid_token'),
                () => sessionStorage.getItem('neuralgrid_token'),
                () => getCookie('neuralgrid_token')
            ];
            
            for (const getToken of sources) {
                const token = getToken();
                if (token && 
                    token !== 'undefined' && 
                    token !== 'null' && 
                    token.trim().length > 20) {
                    return token.trim();
                }
            }
            return null;
        }

        function checkStatus() {
            log('üîç Checking storage status...', 'info');
            
            const localToken = localStorage.getItem('neuralgrid_token');
            const sessionToken = sessionStorage.getItem('neuralgrid_token');
            const cookieToken = getCookie('neuralgrid_token');
            const authToken = getAuthToken();

            document.getElementById('localStorage-token').textContent = 
                localToken ? `${localToken.substring(0, 20)}... (${localToken.length} chars)` : 'null';
            document.getElementById('sessionStorage-token').textContent = 
                sessionToken ? `${sessionToken.substring(0, 20)}... (${sessionToken.length} chars)` : 'null';
            document.getElementById('cookie-token').textContent = 
                cookieToken ? `${cookieToken.substring(0, 20)}... (${cookieToken.length} chars)` : 'null';
            document.getElementById('auth-token-result').textContent = 
                authToken ? `‚úÖ Valid (${authToken.length} chars)` : '‚ùå No valid token';

            if (authToken) {
                log(`‚úÖ Found valid token: ${authToken.length} characters`, 'success');
            } else {
                log('‚ùå No valid token found', 'error');
            }
        }

        async function testLogin() {
            log('üîë Testing login with real credentials...', 'info');
            
            try {
                const response = await fetch('https://auth.neuralgrid.kr/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'aze7009011@gate.com',
                        password: '!QAZ1226119'
                    })
                });

                const data = await response.json();
                log(`Login Response: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');
                
                if (data.success && data.data) {
                    const token = data.data.token || data.token;
                    const user = data.data.user || data.user;
                    
                    log(`‚úÖ Login successful! Token length: ${token?.length || 0}`, 'success');
                    
                    if (token) {
                        localStorage.setItem('neuralgrid_token', token);
                        document.cookie = `neuralgrid_token=${token}; domain=.neuralgrid.kr; path=/; max-age=86400; SameSite=Lax; Secure`;
                        log('‚úÖ Token saved to localStorage and cookie', 'success');
                        checkStatus();
                    } else {
                        log('‚ùå No token in response', 'error');
                    }
                } else {
                    log(`‚ùå Login failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Login error: ${error.message}`, 'error');
            }
        }

        async function testRegister() {
            log('üìù Testing DDoS registration...', 'info');
            
            const token = getAuthToken();
            if (!token) {
                log('‚ùå No token found! Please login first.', 'error');
                return;
            }

            log(`‚úÖ Using token: ${token.substring(0, 30)}...`, 'info');

            try {
                const response = await fetch('https://ddos.neuralgrid.kr/api/servers/register-website', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        companyName: 'Îâ¥Îü¥Í∑∏Î¶¨Îìú ÌÖåÏä§Ìä∏',
                        phone: '010-5137-0745',
                        domains: 'www.eanews.kr, eanews.kr'
                    })
                });

                const data = await response.json();
                log(`Register Response: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');
                
                if (response.ok && data.success) {
                    log('‚úÖ Registration successful!', 'success');
                    log(`Order ID: ${data.order?.orderId}`, 'success');
                    log(`API Key: ${data.apiKey}`, 'success');
                    log(`Install Code length: ${data.installCode?.length || 0}`, 'success');
                } else {
                    log(`‚ùå Registration failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Registration error: ${error.message}`, 'error');
            }
        }

        function clearAll() {
            if (confirm('Î™®Îì† Ï†ÄÏû•ÏÜåÎ•º ÎπÑÏö∞ÏãúÍ≤†ÏäµÎãàÍπå?')) {
                localStorage.clear();
                sessionStorage.clear();
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/;domain=.neuralgrid.kr"); 
                });
                log('üóëÔ∏è All storage cleared', 'warning');
                checkStatus();
            }
        }

        // Initial status check
        window.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Test page loaded', 'info');
            checkStatus();
        });
    </script>
</body>
</html>
