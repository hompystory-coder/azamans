// ë¸”ë¡œê·¸/ê¸°ì‚¬ í¬ë¡¤ë§ API
import express from 'express';
import axios from 'axios';
import * as cheerio from 'cheerio';

const router = express.Router();

// ë„¤ì´ë²„ ë¸”ë¡œê·¸ iframe URL ì¶”ì¶œ
async function getNaverBlogIframeUrl(url) {
  try {
    const response = await axios.get(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      }
    });
    
    const $ = cheerio.load(response.data);
    const iframeSrc = $('#mainFrame').attr('src');
    
    if (iframeSrc) {
      return iframeSrc.startsWith('http') ? iframeSrc : `https://blog.naver.com${iframeSrc}`;
    }
    
    return null;
  } catch (error) {
    return null;
  }
}

// POST /api/crawler/fetch - ë¸”ë¡œê·¸/ê¸°ì‚¬ í¬ë¡¤ë§
router.post('/fetch', async (req, res) => {
  try {
    const { url } = req.body;
    
    if (!url) {
      return res.status(400).json({
        success: false,
        error: 'URLì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    console.log(`ðŸ•·ï¸ í¬ë¡¤ë§ ì‹œìž‘: ${url}`);
    
    let targetUrl = url;
    
    // ë„¤ì´ë²„ ë¸”ë¡œê·¸ iframe URL ì¶”ì¶œ
    if (url.includes('blog.naver.com') && !url.includes('PostView.naver')) {
      const iframeUrl = await getNaverBlogIframeUrl(url);
      if (iframeUrl) {
        console.log(`ðŸ“ ë„¤ì´ë²„ ë¸”ë¡œê·¸ iframe URL: ${iframeUrl}`);
        targetUrl = iframeUrl;
      }
    }
    
    // URL íŽ˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°
    const response = await axios.get(targetUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      },
      timeout: 30000
    });
    
    const html = response.data;
    const $ = cheerio.load(html);
    
    // ì œëª© ì¶”ì¶œ
    let title = $('meta[property="og:title"]').attr('content') ||
                $('title').text() ||
                $('h1').first().text() ||
                '';
    title = title.trim();
    
    // ë³¸ë¬¸ ì¶”ì¶œ (ì—¬ëŸ¬ ì„ íƒìž ì‹œë„)
    const contentSelectors = [
      '.se-main-container',  // ë„¤ì´ë²„ ë¸”ë¡œê·¸ ìŠ¤ë§ˆíŠ¸ì—ë””í„°
      '.se-component-content',  // ë„¤ì´ë²„ ë¸”ë¡œê·¸
      '#postViewArea',  // ë„¤ì´ë²„ ë¸”ë¡œê·¸ (êµ¬ë²„ì „)
      'article',
      '.article-content',
      '.post-content',
      '.entry-content',
      '#content',
      'main',
      '.content'
    ];
    
    let contentText = '';
    for (const selector of contentSelectors) {
      const content = $(selector).text();
      if (content && content.length > contentText.length) {
        contentText = content;
      }
    }
    
    // ë„¤ì´ë²„ ë¸”ë¡œê·¸ íŠ¹ìˆ˜ ì²˜ë¦¬ - p íƒœê·¸ë“¤ ìˆ˜ì§‘
    if (!contentText && targetUrl.includes('blog.naver.com')) {
      const paragraphs = [];
      $('p, .se-text-paragraph').each((i, elem) => {
        const text = $(elem).text().trim();
        if (text && text.length > 10) {
          paragraphs.push(text);
        }
      });
      contentText = paragraphs.join('\n\n');
    }
    
    // í…ìŠ¤íŠ¸ ì •ë¦¬
    contentText = contentText
      .replace(/\s+/g, ' ')
      .replace(/\n+/g, '\n')
      .trim();
    
    // ì´ë¯¸ì§€ ì¶”ì¶œ - ë³¸ë¬¸ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ì´ë¯¸ì§€ë§Œ ì¶”ì¶œ
    const images = [];
    const imageUrls = new Set(); // ì¤‘ë³µ ë°©ì§€
    
    // ë³¸ë¬¸ ì»¨í…Œì´ë„ˆ ì„ íƒìž
    const contentContainerSelectors = [
      '.se-main-container',  // ë„¤ì´ë²„ ë¸”ë¡œê·¸ ìŠ¤ë§ˆíŠ¸ì—ë””í„°
      '.se-component-content',  // ë„¤ì´ë²„ ë¸”ë¡œê·¸
      '#postViewArea',  // ë„¤ì´ë²„ ë¸”ë¡œê·¸ (êµ¬ë²„ì „)
      'article',
      '.article-content',
      '.post-content',
      '.entry-content',
      '#content',
      'main'
    ];
    
    // ë³¸ë¬¸ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
    let $contentContainer = null;
    for (const selector of contentContainerSelectors) {
      const $container = $(selector);
      if ($container.length > 0) {
        $contentContainer = $container.first();
        console.log(`ðŸ“¦ ë³¸ë¬¸ ì»¨í…Œì´ë„ˆ ë°œê²¬: ${selector}`);
        break;
      }
    }
    
    // ë³¸ë¬¸ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ì´ë¯¸ì§€ë§Œ ì¶”ì¶œ
    const $images = $contentContainer ? $contentContainer.find('img') : $('img');
    
    $images.each((i, elem) => {
      let src = $(elem).attr('src') || $(elem).attr('data-src') || $(elem).attr('data-lazy-src');
      
      if (src) {
        // ìƒëŒ€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
        if (src.startsWith('/')) {
          const urlObj = new URL(targetUrl);
          src = `${urlObj.protocol}//${urlObj.host}${src}`;
        } else if (!src.startsWith('http')) {
          const urlObj = new URL(targetUrl);
          src = `${urlObj.protocol}//${urlObj.host}/${src}`;
        }
        
        // ë„¤ì´ë²„ ë¸”ë¡œê·¸ ì´ë¯¸ì§€: type íŒŒë¼ë¯¸í„° ì œê±°í•˜ì—¬ ì›ë³¸ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
        if (src.includes('postfiles.pstatic.net') || src.includes('blogfiles.pstatic.net')) {
          // type íŒŒë¼ë¯¸í„° ì™„ì „ ì œê±° - ì›ë³¸ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          src = src.replace(/[?&]type=[^&]*/, '').replace(/\?$/, '');
          
          // ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ì´ ì—†ìœ¼ë©´ ì›ë³¸ URL ê·¸ëŒ€ë¡œ ì‚¬ìš©
          if (!src.includes('?')) {
            // ì›ë³¸ ì´ë¯¸ì§€ URL
          }
        }
        
        // ìž‘ì€ ì´ë¯¸ì§€ í•„í„°ë§ (ì•„ì´ì½˜, ì´ëª¨í‹°ì½˜ ë“±)
        const width = parseInt($(elem).attr('width') || '9999');
        const height = parseInt($(elem).attr('height') || '9999');
        
        // ëª…ì‹œì ìœ¼ë¡œ ìž‘ì€ ì´ë¯¸ì§€ë§Œ ì œì™¸
        if ((width > 0 && width < 50) || (height > 0 && height < 50)) {
          return; // skip very small images
        }
        
        // UI ìš”ì†Œ ì´ë¯¸ì§€ ì œì™¸
        const srcLower = src.toLowerCase();
        if (srcLower.includes('icon') || 
            srcLower.includes('emoji') || 
            srcLower.includes('btn_') ||
            srcLower.includes('logo') ||
            srcLower.includes('profile') ||
            srcLower.includes('avatar') ||
            srcLower.includes('_preset_') ||
            srcLower.includes('/static/blog/') ||
            (srcLower.includes('.gif') && !srcLower.includes('postfiles'))) {
          return; // skip
        }
        
        // ë„¤ì´ë²„ ë¸”ë¡œê·¸ UI ì´ë¯¸ì§€ ì œì™¸
        if (srcLower.includes('profileimage') || 
            srcLower.includes('mainthumbnailurl') ||
            srcLower.includes('blogpfthumb')) {
          return; // skip
        }
        
        // ì¤‘ë³µ ì œê±°
        if (imageUrls.has(src)) {
          return;
        }
        
        imageUrls.add(src);
        
        // alt í…ìŠ¤íŠ¸
        const alt = $(elem).attr('alt') || '';
        
        // ì´ë¯¸ì§€ í”„ë¡ì‹œ URL ìƒì„±
        const proxyUrl = `/api/image-proxy?url=${encodeURIComponent(src)}`;
        
        images.push({
          url: src,
          proxyUrl: proxyUrl,
          alt: alt.trim()
        });
      }
    });
    
    console.log(`ðŸ–¼ï¸  ë³¸ë¬¸ ì´ë¯¸ì§€ ì¶”ì¶œ: ${images.length}ê°œ`);
    
    console.log(`âœ… í¬ë¡¤ë§ ì™„ë£Œ: ì œëª©="${title}", í…ìŠ¤íŠ¸=${contentText.length}ìž, ì´ë¯¸ì§€=${images.length}ê°œ`);
    
    res.json({
      success: true,
      data: {
        title,
        content: contentText,
        images: images.slice(0, 20), // ìµœëŒ€ 20ê°œ
        url
      }
    });
    
  } catch (error) {
    console.error('âŒ í¬ë¡¤ë§ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'í¬ë¡¤ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

export default router;
