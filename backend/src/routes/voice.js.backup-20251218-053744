// ìŒì„± ìƒì„± API (Minimax API v2 - JSON ì‘ë‹µ ì²˜ë¦¬ ìˆ˜ì •)
import express from 'express';
import axios from 'axios';
import fs from 'fs';
import path from 'path';
import { getOutputPath } from '../utils/storage.js';

const router = express.Router();

// ìŒì„± ìƒ˜í”Œ ëª©ë¡ (íƒ­ë³„)
const VOICE_SAMPLES = {
  male: [
    { id: 'male_001', name: 'ë‚¨ì„± 1 - ì°¨ë¶„í•œ', voice: 'presenter_male' },
    { id: 'male_002', name: 'ë‚¨ì„± 2 - í™œê¸°ì°¬', voice: 'audiobook_male_1' },
    { id: 'male_003', name: 'ë‚¨ì„± 3 - ì „ë¬¸ì ì¸', voice: 'male_news_anchor' }
  ],
  female: [
    { id: 'female_001', name: 'ì—¬ì„± 1 - ë¶€ë“œëŸ¬ìš´', voice: 'presenter_female' },
    { id: 'female_002', name: 'ì—¬ì„± 2 - ë°ì€', voice: 'audiobook_female_1' },
    { id: 'female_003', name: 'ì—¬ì„± 3 - ì „ë¬¸ì ì¸', voice: 'female_news_anchor' }
  ],
  child: [
    { id: 'child_001', name: 'ì–´ë¦°ì´ 1', voice: 'child_voice' }
  ]
};

// GET /api/voice/samples - ìŒì„± ìƒ˜í”Œ ëª©ë¡
router.get('/samples', (req, res) => {
  res.json({
    success: true,
    data: VOICE_SAMPLES
  });
});

// Helper function: voiceIdë¥¼ ì‹¤ì œ Minimax voice IDë¡œ ë³€í™˜
const getMinimaxVoiceId = (voiceId) => {
  // VOICE_SAMPLESì—ì„œ voiceIdì— í•´ë‹¹í•˜ëŠ” voice ì°¾ê¸°
  for (const category of Object.values(VOICE_SAMPLES)) {
    const voice = category.find(v => v.id === voiceId);
    if (voice) {
      return voice.voice;
    }
  }
  // ê¸°ë³¸ê°’
  return 'presenter_male';
};

// POST /api/voice/preview - ìŒì„± ë¯¸ë¦¬ë“£ê¸° (JSON ì‘ë‹µ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬)
router.post('/preview', async (req, res) => {
  try {
    const { text, voiceId, minimaxApiKey, minimaxGroupId } = req.body;
    
    const apiKey = minimaxApiKey || process.env.MINIMAX_API_KEY;
    
    if (!apiKey) {
      return res.status(400).json({
        success: false,
        error: 'Minimax API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    // voiceIdë¥¼ ì‹¤ì œ Minimax voice IDë¡œ ë³€í™˜
    const minimaxVoiceId = getMinimaxVoiceId(voiceId);
    
    console.log(`ğŸ™ï¸ ìŒì„± ë¯¸ë¦¬ë“£ê¸° ìƒì„±: voiceId=${voiceId} â†’ minimaxVoiceId=${minimaxVoiceId}`);
    
    // Minimax T2A API v2 í˜¸ì¶œ (JSON ì‘ë‹µ ì²˜ë¦¬)
    const response = await axios.post(
      'https://api.minimax.io/v1/t2a_v2',
      {
        model: 'speech-2.6-hd',
        text: text || 'ì•ˆë…•í•˜ì„¸ìš”. ì´ê²ƒì€ ìŒì„± ìƒ˜í”Œì…ë‹ˆë‹¤.',
        voice_setting: {
          voice_id: minimaxVoiceId,
          speed: 1.0,
          vol: 1.0,
          pitch: 0
        },
        audio_setting: {
          sample_rate: 32000,
          bitrate: 128000,
          format: 'mp3'
        }
      },
      {
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        }
        // âŒ responseType ì œê±° â†’ JSONìœ¼ë¡œ ë°›ìŒ
      }
    );
    
    console.log('ğŸ“¦ Minimax API ì‘ë‹µ:', JSON.stringify(response.data).substring(0, 200));
    
    // âœ… JSON ì‘ë‹µ í™•ì¸ ë° ì²˜ë¦¬
    if (response.data && response.data.base_resp) {
      const { base_resp, data: audioData, extra_info } = response.data;
      
      // ì—ëŸ¬ ì‘ë‹µ ì²´í¬
      if (base_resp.status_code !== 0) {
        console.error('âŒ Minimax API ì—ëŸ¬:', base_resp.status_msg);
        return res.status(400).json({
          success: false,
          error: base_resp.status_msg || 'Minimax API ìš”ì²­ ì‹¤íŒ¨'
        });
      }
      
      // âœ… ì„±ê³µ! ì˜¤ë””ì˜¤ ë°ì´í„° ì¶”ì¶œ
      if (!audioData || !audioData.audio) {
        throw new Error('ì‘ë‹µì— ì˜¤ë””ì˜¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
      
      // âœ… Minimax APIëŠ” HEX ì¸ì½”ë”©ëœ ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ë°˜í™˜í•¨
      // Hex â†’ Buffer â†’ Base64 ë³€í™˜ í•„ìš”
      const audioHex = audioData.audio;
      const audioBuffer = Buffer.from(audioHex, 'hex');
      const audioBase64 = audioBuffer.toString('base64');
      
      console.log(`âœ… ìŒì„± ë¯¸ë¦¬ë“£ê¸° ìƒì„± ì™„ë£Œ (í¬ê¸°: ${extra_info?.audio_size || 'ì•Œ ìˆ˜ ì—†ìŒ'} bytes, ê¸¸ì´: ${extra_info?.audio_length || 0}ms)`);
      console.log(`   ğŸ“Š Hex ê¸¸ì´: ${audioHex.length} chars â†’ Base64 ê¸¸ì´: ${audioBase64.length} chars`);
      
      res.json({
        success: true,
        data: {
          audioData: `data:audio/mp3;base64,${audioBase64}`,
          duration: extra_info?.audio_length / 1000 || 3.0  // ms â†’ seconds
        }
      });
    } else {
      throw new Error('ì˜ˆìƒí•˜ì§€ ëª»í•œ API ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤.');
    }
    
  } catch (error) {
    console.error('âŒ ìŒì„± ë¯¸ë¦¬ë“£ê¸° ì˜¤ë¥˜:', error.response?.data || error.message);
    
    // Axios ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬
    if (error.response && error.response.data && error.response.data.base_resp) {
      return res.status(error.response.status).json({
        success: false,
        error: error.response.data.base_resp.status_msg || 'ìŒì„± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
      });
    }
    
    res.status(500).json({
      success: false,
      error: error.message || 'ìŒì„± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// POST /api/voice/generate - ì¥ë©´ë³„ ìŒì„± ìƒì„± (JSON ì‘ë‹µ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬)
router.post('/generate', async (req, res) => {
  try {
    const { scenes, voiceId, minimaxApiKey, minimaxGroupId } = req.body;
    
    const apiKey = minimaxApiKey || process.env.MINIMAX_API_KEY;
    
    if (!apiKey) {
      return res.status(400).json({
        success: false,
        error: 'Minimax API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    if (!scenes || scenes.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'ì¥ë©´ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    // voiceIdë¥¼ ì‹¤ì œ Minimax voice IDë¡œ ë³€í™˜
    const minimaxVoiceId = getMinimaxVoiceId(voiceId);
    console.log(`ğŸ™ï¸ ${scenes.length}ê°œ ì¥ë©´ì˜ ìŒì„± ìƒì„± ì‹œì‘... (voice: ${minimaxVoiceId})`);
    
    const audioFiles = [];
    
    // ê° ì¥ë©´ë³„ë¡œ ìŒì„± ìƒì„±
    for (let i = 0; i < scenes.length; i++) {
      const scene = scenes[i];
      console.log(`   ì¥ë©´ ${i + 1}/${scenes.length}: "${scene.narration.substring(0, 30)}..."`);
      
      // Minimax T2A API v2 í˜¸ì¶œ (JSON ì‘ë‹µ ì²˜ë¦¬)
      const response = await axios.post(
        'https://api.minimax.io/v1/t2a_v2',
        {
          model: 'speech-2.6-hd',
          text: scene.narration,
          voice_setting: {
            voice_id: minimaxVoiceId,
            speed: 1.0,
            vol: 1.0,
            pitch: 0
          },
          audio_setting: {
            sample_rate: 32000,
            bitrate: 128000,
            format: 'mp3'
          }
        },
        {
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          }
          // âŒ responseType ì œê±° â†’ JSONìœ¼ë¡œ ë°›ìŒ
        }
      );
      
      // âœ… JSON ì‘ë‹µ í™•ì¸ ë° ì²˜ë¦¬
      if (response.data && response.data.base_resp) {
        const { base_resp, data: audioData, extra_info } = response.data;
        
        // ì—ëŸ¬ ì‘ë‹µ ì²´í¬
        if (base_resp.status_code !== 0) {
          console.error(`âŒ ì¥ë©´ ${i + 1} Minimax API ì—ëŸ¬:`, base_resp.status_msg);
          throw new Error(`ì¥ë©´ ${i + 1} ìƒì„± ì‹¤íŒ¨: ${base_resp.status_msg}`);
        }
        
        // âœ… ì„±ê³µ! ì˜¤ë””ì˜¤ ë°ì´í„° ì¶”ì¶œ
        if (!audioData || !audioData.audio) {
          throw new Error(`ì¥ë©´ ${i + 1}: ì‘ë‹µì— ì˜¤ë””ì˜¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        }
        
        // âœ… Minimax APIëŠ” HEX ì¸ì½”ë”©ëœ ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ë°˜í™˜í•¨
        // Hex â†’ Buffer â†’ Base64 ë³€í™˜
        const audioHex = audioData.audio;
        const audioBuffer = Buffer.from(audioHex, 'hex');
        const audioBase64 = audioBuffer.toString('base64');
        
        // íŒŒì¼ë¡œ ì €ì¥
        const filename = `scene_${i + 1}_${Date.now()}.mp3`;
        const filepath = getOutputPath(path.join('audio', filename));
        
        await fs.promises.writeFile(filepath, audioBuffer);
        
        // ì‹¤ì œ ì˜¤ë””ì˜¤ ê¸¸ì´ ì‚¬ìš©
        const duration = (extra_info?.audio_length || 3000) / 1000;  // ms â†’ seconds
        
        audioFiles.push({
          sceneNumber: i + 1,
          filename,
          filepath,
          url: `/outputs/audio/${filename}`,
          audioData: `data:audio/mp3;base64,${audioBase64}`,  // âœ… ë¯¸ë¦¬ë“£ê¸°ìš© base64 ë°ì´í„°
          duration
        });
        
        console.log(`   âœ… ì¥ë©´ ${i + 1} ì™„ë£Œ: ${filename} (${duration}ì´ˆ)`);
      } else {
        throw new Error(`ì¥ë©´ ${i + 1}: ì˜ˆìƒí•˜ì§€ ëª»í•œ API ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤.`);
      }
    }
    
    console.log(`âœ… ëª¨ë“  ìŒì„± ìƒì„± ì™„ë£Œ: ${audioFiles.length}ê°œ íŒŒì¼`);
    
    res.json({
      success: true,
      data: {
        audioFiles,
        totalDuration: audioFiles.reduce((sum, f) => sum + f.duration, 0)
      }
    });
    
  } catch (error) {
    console.error('âŒ ìŒì„± ìƒì„± ì˜¤ë¥˜:', error.response?.data || error.message);
    
    // Axios ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬
    if (error.response && error.response.data && error.response.data.base_resp) {
      return res.status(error.response.status).json({
        success: false,
        error: error.response.data.base_resp.status_msg || 'ìŒì„± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
      });
    }
    
    res.status(500).json({
      success: false,
      error: error.message || 'ìŒì„± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

export default router;
