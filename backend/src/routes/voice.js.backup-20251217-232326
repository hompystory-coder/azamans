// ìŒì„± ìƒì„± API (Minimax API)
import express from 'express';
import axios from 'axios';
import fs from 'fs';
import path from 'path';
import { getOutputPath } from '../utils/storage.js';

const router = express.Router();

// ìŒì„± ìƒ˜í”Œ ëª©ë¡ (íƒ­ë³„)
const VOICE_SAMPLES = {
  male: [
    { id: 'male_001', name: 'ë‚¨ì„± 1 - ì°¨ë¶„í•œ', voice: 'presenter_male' },
    { id: 'male_002', name: 'ë‚¨ì„± 2 - í™œê¸°ì°¬', voice: 'audiobook_male_1' },
    { id: 'male_003', name: 'ë‚¨ì„± 3 - ì „ë¬¸ì ì¸', voice: 'male_news_anchor' }
  ],
  female: [
    { id: 'female_001', name: 'ì—¬ì„± 1 - ë¶€ë“œëŸ¬ìš´', voice: 'presenter_female' },
    { id: 'female_002', name: 'ì—¬ì„± 2 - ë°ì€', voice: 'audiobook_female_1' },
    { id: 'female_003', name: 'ì—¬ì„± 3 - ì „ë¬¸ì ì¸', voice: 'female_news_anchor' }
  ],
  child: [
    { id: 'child_001', name: 'ì–´ë¦°ì´ 1', voice: 'child_voice' }
  ]
};

// GET /api/voice/samples - ìŒì„± ìƒ˜í”Œ ëª©ë¡
router.get('/samples', (req, res) => {
  res.json({
    success: true,
    data: VOICE_SAMPLES
  });
});

// Helper function: voiceIdë¥¼ ì‹¤ì œ Minimax voice IDë¡œ ë³€í™˜
const getMinimaxVoiceId = (voiceId) => {
  // VOICE_SAMPLESì—ì„œ voiceIdì— í•´ë‹¹í•˜ëŠ” voice ì°¾ê¸°
  for (const category of Object.values(VOICE_SAMPLES)) {
    const voice = category.find(v => v.id === voiceId);
    if (voice) {
      return voice.voice;
    }
  }
  // ê¸°ë³¸ê°’
  return 'presenter_male';
};

// POST /api/voice/preview - ìŒì„± ë¯¸ë¦¬ë“£ê¸°
router.post('/preview', async (req, res) => {
  try {
    const { text, voiceId, minimaxApiKey, minimaxGroupId } = req.body;
    
    const apiKey = minimaxApiKey || process.env.MINIMAX_API_KEY;
    const groupId = minimaxGroupId || process.env.MINIMAX_GROUP_ID;
    
    if (!apiKey || !groupId) {
      return res.status(400).json({
        success: false,
        error: 'Minimax API í‚¤ì™€ Group IDê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    // voiceIdë¥¼ ì‹¤ì œ Minimax voice IDë¡œ ë³€í™˜
    const minimaxVoiceId = getMinimaxVoiceId(voiceId);
    
    console.log(`ğŸ™ï¸ ìŒì„± ë¯¸ë¦¬ë“£ê¸° ìƒì„±: voiceId=${voiceId} â†’ minimaxVoiceId=${minimaxVoiceId}`);
    
    // Minimax TTS API í˜¸ì¶œ
    const response = await axios.post(
      'https://api.minimax.chat/v1/text_to_speech',
      {
        model: 'speech-01',
        text: text || 'ì•ˆë…•í•˜ì„¸ìš”. ì´ê²ƒì€ ìŒì„± ìƒ˜í”Œì…ë‹ˆë‹¤.',
        voice_id: minimaxVoiceId,
        speed: 1.0,
        vol: 1.0,
        pitch: 0,
        audio_sample_rate: 24000,
        bitrate: 128000
      },
      {
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'GroupId': groupId,
          'Content-Type': 'application/json'
        },
        responseType: 'arraybuffer'
      }
    );
    
    // ì‘ë‹µì´ ì‹¤ì œ ì˜¤ë””ì˜¤ ë°ì´í„°ì¸ì§€ í™•ì¸ (JSON ì—ëŸ¬ ì‘ë‹µì´ ì•„ë‹Œì§€ ì²´í¬)
    const responseBuffer = Buffer.from(response.data);
    
    // JSON ì—ëŸ¬ ì‘ë‹µì¸ì§€ í™•ì¸ (ì²« ë°”ì´íŠ¸ê°€ '{' ì¸ ê²½ìš°)
    if (responseBuffer[0] === 0x7B) { // '{' character
      const errorJson = responseBuffer.toString('utf-8');
      console.error('âŒ Minimax API ì—ëŸ¬ ì‘ë‹µ:', errorJson);
      
      try {
        const errorData = JSON.parse(errorJson);
        return res.status(400).json({
          success: false,
          error: errorData.base_resp?.status_msg || 'Minimax API ì¸ì¦ ì‹¤íŒ¨'
        });
      } catch (e) {
        return res.status(400).json({
          success: false,
          error: 'Minimax API ìš”ì²­ ì‹¤íŒ¨'
        });
      }
    }
    
    console.log(`âœ… ìŒì„± ë¯¸ë¦¬ë“£ê¸° ìƒì„± ì™„ë£Œ (í¬ê¸°: ${responseBuffer.length} bytes)`);
    
    // Base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ë°˜í™˜
    const audioBase64 = responseBuffer.toString('base64');
    
    res.json({
      success: true,
      data: {
        audioData: `data:audio/mp3;base64,${audioBase64}`
      }
    });
    
  } catch (error) {
    console.error('âŒ ìŒì„± ë¯¸ë¦¬ë“£ê¸° ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ìŒì„± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// POST /api/voice/generate - ì¥ë©´ë³„ ìŒì„± ìƒì„±
router.post('/generate', async (req, res) => {
  try {
    const { scenes, voiceId, minimaxApiKey, minimaxGroupId } = req.body;
    
    const apiKey = minimaxApiKey || process.env.MINIMAX_API_KEY;
    const groupId = minimaxGroupId || process.env.MINIMAX_GROUP_ID;
    
    if (!apiKey || !groupId) {
      return res.status(400).json({
        success: false,
        error: 'Minimax API í‚¤ì™€ Group IDê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    if (!scenes || scenes.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'ì¥ë©´ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    // voiceIdë¥¼ ì‹¤ì œ Minimax voice IDë¡œ ë³€í™˜
    const minimaxVoiceId = getMinimaxVoiceId(voiceId);
    console.log(`ğŸ™ï¸ ${scenes.length}ê°œ ì¥ë©´ì˜ ìŒì„± ìƒì„± ì‹œì‘... (voice: ${minimaxVoiceId})`);
    
    const audioFiles = [];
    
    // ê° ì¥ë©´ë³„ë¡œ ìŒì„± ìƒì„±
    for (let i = 0; i < scenes.length; i++) {
      const scene = scenes[i];
      console.log(`   ì¥ë©´ ${i + 1}/${scenes.length}: "${scene.narration.substring(0, 30)}..."`);
      
      // Minimax TTS API í˜¸ì¶œ
      const response = await axios.post(
        'https://api.minimax.chat/v1/text_to_speech',
        {
          model: 'speech-01',
          text: scene.narration,
          voice_id: minimaxVoiceId,
          speed: 1.0,
          vol: 1.0,
          pitch: 0,
          audio_sample_rate: 24000,
          bitrate: 128000
        },
        {
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'GroupId': groupId,
            'Content-Type': 'application/json'
          },
          responseType: 'arraybuffer'
        }
      );
      
      // ì‘ë‹µì´ ì‹¤ì œ ì˜¤ë””ì˜¤ ë°ì´í„°ì¸ì§€ í™•ì¸
      const responseBuffer = Buffer.from(response.data);
      
      // JSON ì—ëŸ¬ ì‘ë‹µì¸ì§€ í™•ì¸
      if (responseBuffer[0] === 0x7B) { // '{' character
        const errorJson = responseBuffer.toString('utf-8');
        console.error(`âŒ ì¥ë©´ ${i + 1} Minimax API ì—ëŸ¬:`, errorJson);
        throw new Error('Minimax API ì¸ì¦ ì‹¤íŒ¨');
      }
      
      // íŒŒì¼ë¡œ ì €ì¥
      const filename = `scene_${i + 1}_${Date.now()}.mp3`;
      const filepath = getOutputPath(path.join('audio', filename));
      
      await fs.promises.writeFile(filepath, responseBuffer);
      
      // FFprobeë¡œ ì˜¤ë””ì˜¤ ê¸¸ì´ í™•ì¸ (ê°„ë‹¨í•˜ê²Œ ì¶”ì •)
      const duration = scene.duration || 3.0;
      
      audioFiles.push({
        sceneNumber: i + 1,
        filename,
        filepath,
        url: `/outputs/audio/${filename}`,
        duration
      });
      
      console.log(`   âœ… ì¥ë©´ ${i + 1} ì™„ë£Œ: ${filename}`);
    }
    
    console.log(`âœ… ëª¨ë“  ìŒì„± ìƒì„± ì™„ë£Œ: ${audioFiles.length}ê°œ íŒŒì¼`);
    
    res.json({
      success: true,
      data: {
        audioFiles,
        totalDuration: audioFiles.reduce((sum, f) => sum + f.duration, 0)
      }
    });
    
  } catch (error) {
    console.error('âŒ ìŒì„± ìƒì„± ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message || 'ìŒì„± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

export default router;
