# ============================================
# NeuralGrid DDoS Defense - Rate Limiting
# ============================================
# 이 설정을 /etc/nginx/conf.d/rate-limiting.conf에 추가

# Rate Limiting Zones 정의
# ============================================

# 1. 일반 웹 페이지 (10 req/s)
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

# 2. API 엔드포인트 (30 req/s)
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

# 3. 로그인 페이지 (3 req/s - 브루트포스 방어)
limit_req_zone $binary_remote_addr zone=login:10m rate=3r/s;

# 4. 정적 파일 (50 req/s)
limit_req_zone $binary_remote_addr zone=static:10m rate=50r/s;

# Connection Limiting (동시 연결 수 제한)
# ============================================
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
limit_conn_zone $server_name zone=perserver:10m;

# Request Body Size Limiting
# ============================================
client_max_body_size 100m;
client_body_buffer_size 128k;
client_header_buffer_size 1k;
large_client_header_buffers 4 16k;

# Timeout 설정 (Slowloris 공격 방어)
# ============================================
client_body_timeout 10s;
client_header_timeout 10s;
keepalive_timeout 30s;
send_timeout 10s;

# Connection 제한
# ============================================
reset_timedout_connection on;

# 로그 포맷 정의 (공격 분석용)
# ============================================
log_format ddos_defense '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        '$request_time $upstream_response_time '
                        '$pipe $connection $connection_requests';

# GeoIP 설정 (선택사항)
# ============================================
# geoip_country /usr/share/GeoIP/GeoIP.dat;
# geoip_city /usr/share/GeoIP/GeoIPCity.dat;

# map $geoip_country_code $allowed_country {
#     default no;
#     KR yes;  # 한국
#     US yes;  # 미국
#     JP yes;  # 일본
# }

# 악성 봇 차단 (User-Agent 기반)
# ============================================
map $http_user_agent $bad_bot {
    default 0;
    "~*aggressive" 1;
    "~*archiver" 1;
    "~*backdoor" 1;
    "~*bandwidth" 1;
    "~*bot" 1;
    "~*casper" 1;
    "~*clshttp" 1;
    "~*cmsworldmap" 1;
    "~*comodo" 1;
    "~*copier" 1;
    "~*cosmos" 1;
    "~*crawler" 1;
    "~*curious" 1;
    "~*disco" 1;
    "~*dispatcher" 1;
    "~*download" 1;
    "~*downloader" 1;
    "~*dumper" 1;
    "~*easyhttp" 1;
    "~*ecatch" 1;
    "~*eirgrabber" 1;
    "~*email" 1;
    "~*extract" 1;
    "~*eyenetie" 1;
    "~*fasthttp" 1;
    "~*flashget" 1;
    "~*getright" 1;
    "~*getwebpage" 1;
    "~*grafula" 1;
    "~*harvest" 1;
    "~*hloader" 1;
    "~*httplib" 1;
    "~*httrack" 1;
    "~*humanlinks" 1;
    "~*ieautodiscovery" 1;
    "~*infonavirobot" 1;
    "~*iron33" 1;
    "~*jennybot" 1;
    "~*jetcar" 1;
    "~*joc" 1;
    "~*justify" 1;
    "~*kenjin" 1;
    "~*libweb" 1;
    "~*libwww" 1;
    "~*linkwalker" 1;
    "~*loader" 1;
    "~*mass" 1;
    "~*miner" 1;
    "~*nikto" 1;
    "~*nutch" 1;
    "~*octopus" 1;
    "~*pagegrabber" 1;
    "~*papa" 1;
    "~*pavuk" 1;
    "~*pcbrowser" 1;
    "~*pockey" 1;
    "~*propowerbot" 1;
    "~*proxies" 1;
    "~*proxy" 1;
    "~*psbot" 1;
    "~*python" 1;
    "~*reaper" 1;
    "~*recorder" 1;
    "~*reget" 1;
    "~*retriever" 1;
    "~*robot" 1;
    "~*scanner" 1;
    "~*scraper" 1;
    "~*siphon" 1;
    "~*slurp" 1;
    "~*spider" 1;
    "~*stripper" 1;
    "~*sucker" 1;
    "~*superhttp" 1;
    "~*teleport" 1;
    "~*true_robot" 1;
    "~*turnit" 1;
    "~*vampire" 1;
    "~*vikspider" 1;
    "~*webbandit" 1;
    "~*webcatcher" 1;
    "~*webcopy" 1;
    "~*webenhancer" 1;
    "~*webmasterworldforumbot" 1;
    "~*webripper" 1;
    "~*websauger" 1;
    "~*webstripper" 1;
    "~*webvac" 1;
    "~*webzip" 1;
    "~*wget" 1;
    "~*widows" 1;
    "~*windows 95" 1;
    "~*windows 98" 1;
    "~*winhttp" 1;
    "~*wwwoffle" 1;
    "~*xaldon" 1;
    "~*zeus" 1;
    "~*zmeu" 1;
    
    # 허용된 봇 (예외)
    "~*googlebot" 0;
    "~*bingbot" 0;
    "~*slackbot" 0;
    "~*telegrambot" 0;
}

# 빈 User-Agent 차단
# ============================================
map $http_user_agent $empty_ua {
    default 0;
    "" 1;
}

# Referer 스팸 차단
# ============================================
map $http_referer $bad_referer {
    default 0;
    "~*semalt.com" 1;
    "~*buttons-for-website.com" 1;
    "~*make-money-online.com" 1;
    "~*free-traffic.xyz" 1;
}

# ============================================
# 각 서버 블록에 적용할 설정
# ============================================
# 
# server {
#     # Rate Limiting 적용
#     limit_req zone=general burst=20 nodelay;
#     limit_conn conn_limit 10;
#     limit_conn perserver 1000;
#     
#     # 악성 봇 차단
#     if ($bad_bot) {
#         return 403;
#     }
#     
#     if ($empty_ua) {
#         return 403;
#     }
#     
#     if ($bad_referer) {
#         return 403;
#     }
#     
#     # GeoIP 차단 (선택사항)
#     # if ($allowed_country = no) {
#     #     return 403;
#     # }
#     
#     # 로그 기록
#     access_log /var/log/nginx/access.log ddos_defense;
#     
#     location / {
#         # 일반 Rate Limiting
#         limit_req zone=general burst=20 nodelay;
#     }
#     
#     location /api/ {
#         # API Rate Limiting (더 높은 제한)
#         limit_req zone=api burst=50 nodelay;
#     }
#     
#     location /login {
#         # 로그인 Rate Limiting (엄격)
#         limit_req zone=login burst=5 nodelay;
#     }
#     
#     location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
#         # 정적 파일 Rate Limiting (느슨)
#         limit_req zone=static burst=100 nodelay;
#         expires 30d;
#     }
# }
